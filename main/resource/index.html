<!DOCTYPE html>
<html class="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>V2rayPool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="/static/layui/css/layui.css" rel="stylesheet">
  <script src="/static/layui/layui.js"></script>
  <script src='/static/js/request.js' type='text/javascript'></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'cyber-purple': '#8B5CF6',
            'cyber-red': '#EF4444',
            'cyber-black': '#0F0F23',
            'cyber-dark': '#1A1A2E',
            'cyber-darker': '#16213E',
            'neon-purple': '#A855F7',
            'neon-red': '#F87171',
            'neon-blue': '#60A5FA'
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'scan': 'scan 2s linear infinite',
          },
          keyframes: {
            glow: {
              '0%': { boxShadow: '0 0 5px #8B5CF6, 0 0 10px #8B5CF6, 0 0 15px #8B5CF6' },
              '100%': { boxShadow: '0 0 10px #8B5CF6, 0 0 20px #8B5CF6, 0 0 30px #8B5CF6' }
            },
            scan: {
              '0%': { transform: 'translateX(-100%)' },
              '100%': { transform: 'translateX(100%)' }
            }
          }
        }
      }
    }
  </script>
  <style>
    /* 自定义科技风格样式 */
    .cyber-border {
      border: 1px solid #8B5CF6;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
    }

    .cyber-glow {
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }

    .cyber-button {
      background: linear-gradient(45deg, #8B5CF6, #A855F7);
      border: 1px solid #8B5CF6;
      transition: all 0.3s ease;
    }

    .cyber-button:hover {
      background: linear-gradient(45deg, #A855F7, #C084FC);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
      transform: translateY(-2px);
    }

    .cyber-button-red {
      background: linear-gradient(45deg, #EF4444, #F87171);
      border: 1px solid #EF4444;
    }

    .cyber-button-red:hover {
      background: linear-gradient(45deg, #F87171, #FCA5A5);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
    }

    .status-running {
      color: #10B981;
      text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    .status-stopped {
      color: #6B7280;
    }

    /* 表格科技风格样式 */
    .layui-table {
      background: transparent !important;
      color: #fff !important;
    }

    .layui-table-header {
      background: linear-gradient(135deg, #1A1A2E, #16213E) !important;
      color: #8B5CF6 !important;
    }

    .layui-table th {
      background: linear-gradient(135deg, #1A1A2E, #16213E) !important;
      color: #8B5CF6 !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
      font-weight: 600 !important;
    }

    .layui-table tbody tr {
      background: rgba(26, 26, 46, 0.6) !important;
      color: #fff !important;
    }

    .layui-table tbody tr:nth-child(even) {
      background: rgba(22, 33, 62, 0.6) !important;
    }

    .layui-table tbody tr:hover {
      background: rgba(139, 92, 246, 0.2) !important;
    }

    .layui-table td {
      border-color: rgba(139, 92, 246, 0.2) !important;
      color: #fff !important;
    }

    .layui-table-tool {
      background: rgba(26, 26, 46, 0.8) !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
    }

    .layui-table-tool .layui-inline {
      color: #8B5CF6 !important;
    }

    .layui-table-page {
      background: rgba(26, 26, 46, 0.8) !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
    }

    /* 表格容器样式 */
    .cyber-table {
      background: rgba(26, 26, 46, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }

    .cyber-header {
      background: linear-gradient(135deg, #0F0F23, #1A1A2E);
      border-bottom: 2px solid #8B5CF6;
    }

    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1A1A2E;
    }

    ::-webkit-scrollbar-thumb {
      background: #8B5CF6;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #A855F7;
    }

    /* 全局字体放大10% */
    html {
      font-size: 110%;
    }

    /* 弹窗科技风格样式 */
    .layui-layer {
      background: rgba(26, 26, 46, 0.95) !important;
      border: 1px solid rgba(139, 92, 246, 0.5) !important;
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.3) !important;
    }

    .layui-layer-title {
      background: linear-gradient(135deg, #1A1A2E, #16213E) !important;
      color: #8B5CF6 !important;
      border-bottom: 1px solid rgba(139, 92, 246, 0.3) !important;
      font-weight: 600 !important;
    }

    .layui-layer-content {
      background: rgba(26, 26, 46, 0.9) !important;
      color: #fff !important;
    }

    .layui-layer-btn {
      background: rgba(26, 26, 46, 0.9) !important;
      border-top: 1px solid rgba(139, 92, 246, 0.3) !important;
    }

    .layui-layer-btn a {
      background: linear-gradient(45deg, #8B5CF6, #A855F7) !important;
      color: #fff !important;
      border: 1px solid #8B5CF6 !important;
      transition: all 0.3s ease !important;
    }

    .layui-layer-btn a:hover {
      background: linear-gradient(45deg, #A855F7, #C084FC) !important;
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.5) !important;
    }

    .layui-layer-btn .layui-layer-btn1 {
      background: linear-gradient(45deg, #6B7280, #9CA3AF) !important;
    }

    .layui-layer-btn .layui-layer-btn1:hover {
      background: linear-gradient(45deg, #9CA3AF, #D1D5DB) !important;
    }

    /* 表单元素科技风格 */
    .layui-form-item .layui-form-label {
      background: rgba(139, 92, 246, 0.1) !important;
      color: #8B5CF6 !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
    }

    .layui-input, .layui-textarea, .layui-select {
      background: rgba(26, 26, 46, 0.8) !important;
      border-color: rgba(139, 92, 246, 0.3) !important;
      color: #fff !important;
    }

    .layui-input:focus, .layui-textarea:focus {
      border-color: #8B5CF6 !important;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.3) !important;
    }

    /* 消息提示科技风格 */
    .layui-layer-msg {
      background: rgba(26, 26, 46, 0.95) !important;
      border: 1px solid rgba(139, 92, 246, 0.5) !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.4) !important;
    }
  </style>
</head>

<body class="bg-cyber-black text-white min-h-screen overflow-x-hidden">
  <!-- 科技风格背景 -->
  <div class="fixed inset-0 bg-gradient-to-br from-cyber-black via-cyber-dark to-cyber-darker"></div>
  <div class="fixed inset-0 opacity-10">
    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-cyber-purple to-transparent animate-scan"></div>
  </div>

  <!-- GitHub角标 -->
  <a href="https://github.com/iotames/v2raypool/" target="_blank"
     class="fixed top-4 right-4 z-50 text-cyber-purple hover:text-neon-purple transition-colors duration-300">
    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
    </svg>
  </a>

  <!-- 主容器 - 全屏布局 -->
  <div class="relative z-10 h-screen flex flex-col">
    <!-- 标题区域 - 紧凑版 -->
    <div class="text-center py-4 border-b border-cyber-purple/30">
      <h1 class="text-3xl font-bold bg-gradient-to-r from-cyber-purple via-neon-purple to-cyber-red bg-clip-text text-transparent">
        V2rayPool
      </h1>
      <p class="text-gray-400 text-sm">启用是设置系统代理就像v2ray，运行只是打开端口 </p>
    </div>

    <!-- 主内容区域 - 占满剩余空间 -->
    <div class="flex-1 flex flex-col">
      <!-- 标签页导航 - 紧凑版 -->
      <div class="flex border-b border-cyber-purple/30 bg-cyber-dark/30">
        <button class="tab-header active px-4 py-2 text-cyber-purple border-b-2 border-cyber-purple font-medium transition-all duration-300" data-tab="proxy-pool">
          动态代理池
        </button>
        <button class="tab-header px-4 py-2 text-gray-400 hover:text-cyber-purple transition-all duration-300" data-tab="v2ray-list">
          V2ray列表
        </button>
      </div>

      <!-- 标签内容区域 -->
      <div class="flex-1 flex flex-col">
        <div id="proxy-pool-content" class="tab-pane active flex-1 flex flex-col">
          <!-- 控制面板 - 紧凑版 -->
          <div class="p-3 bg-cyber-dark/20 border-b border-cyber-purple/20">
            <div class="flex flex-wrap items-center gap-2">
              <!-- 测速域名选择 -->
              <select class="bg-cyber-darker border border-cyber-purple/30 rounded px-3 py-1 text-white text-sm focus:border-cyber-purple outline-none" lay-filter="test_domain">
                <option value="">选择测速域名</option>
                <{% range .TestedDomainList %}>
                <option value="<{% . %}>" <{%if strContains $.TestUrl . %}>selected<{%end%}> ><{% . %}></option>
                <{% end %}>
              </select>

              <!-- 控制按钮组 - 紧凑版 -->
              <button class="cyber-button-red text-white px-3 py-1 rounded text-sm font-medium transition-all duration-300" id="testproxynodes">
                测速
              </button>

              <button class="cyber-button text-white px-3 py-1 rounded text-sm font-medium transition-all duration-300" id="startproxynodes">
                启动代理池
              </button>

              <button class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-all duration-300" id="stopproxynodes">
                停止代理池
              </button>

              <button class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-3 py-1 rounded text-sm font-medium transition-all duration-300" lay-on="subscribe">
                更新订阅
              </button>

              <button class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white px-3 py-1 rounded text-sm font-medium transition-all duration-300" lay-on="routingrules">
                路由规则
              </button>
            </div>
          </div>

          <!-- 代理节点表格 - 使用系统滚动条 -->
          <div class="cyber-table">
            <table class="layui-hide" id="nodeslist" lay-filter="nodeslist"></table>
          </div>
        </div>

        <div id="v2ray-list-content" class="tab-pane hidden flex-1">
          <{% tplinclude "v2raylist.html" . | println %}>
        </div>
      </div>
    </div>
  </div>

  <!-- 工具栏模板 - 已集成到主界面 -->

  <script type="text/html" id="toolbarV2ray">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-on="addv2ray"><i class="layui-icon layui-icon-add-1"></i>v2ray</button>
  </div>
</script>

  <script type="text/html" id="barDemo">
  <div class="flex space-x-1">
    <button class="px-2 py-1 text-xs rounded-md font-medium transition-all duration-300 {{= d.is_running ? 'bg-gradient-to-r from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700' : 'bg-gradient-to-r from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700' }}" lay-event="toggleRun">
      {{= d.is_running ? '停止' : '运行' }}
    </button>
    <button class="px-2 py-1 text-xs rounded-md font-medium transition-all duration-300 {{= d.is_active ? 'bg-gradient-to-r from-cyber-purple to-neon-purple text-white shadow-lg' : 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white hover:from-blue-600 hover:to-indigo-600' }}" lay-event="active">
      {{= d.is_active ? '✓ 已启用' : '启用' }}
    </button>
    <button class="px-2 py-1 text-xs rounded-md font-medium bg-gradient-to-r from-gray-500 to-gray-600 text-white hover:from-gray-600 hover:to-gray-700 transition-all duration-300" lay-event="delete">
      删除
    </button>
  </div>
</script>

  <script>
    // import { postjson } from "./request.js";
    // const postjson = require('./request');
    var showTips = function (msg, ele) {
      layer.tips(msg, ele);
    }

    // 科技风格标签页切换
    document.addEventListener('DOMContentLoaded', function() {
      const tabHeaders = document.querySelectorAll('.tab-header');
      const tabPanes = document.querySelectorAll('.tab-pane');

      tabHeaders.forEach(header => {
        header.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');

          // 移除所有活动状态
          tabHeaders.forEach(h => {
            h.classList.remove('active', 'border-cyber-purple', 'text-cyber-purple');
            h.classList.add('text-gray-400');
          });
          tabPanes.forEach(p => {
            p.classList.remove('active');
            p.classList.add('hidden');
          });

          // 添加当前活动状态
          this.classList.add('active', 'border-cyber-purple', 'text-cyber-purple');
          this.classList.remove('text-gray-400');
          document.getElementById(targetTab + '-content').classList.remove('hidden');
          document.getElementById(targetTab + '-content').classList.add('active');

          // 如果切换到v2ray列表，重新加载表格
          if (targetTab === 'v2ray-list') {
            layui.table.reload('v2raylist');
          }
        });
      });
    });

    // 排序状态管理
    let sortState = 0; // 0: 默认, 1: 正序(运行->停止), 2: 倒序(停止->运行)
    let originalData = null; // 保存原始数据
    layui.use(['table', 'dropdown', 'form'], function () {
      var table = layui.table;
      var dropdown = layui.dropdown;
      var layer = layui.layer;
      var util = layui.util;
      var form = layui.form;
      var $ = layui.$;
      var element = layui.element;
      // tab 切换事件
      element.on('tab(v2raytab)', function (data) {
        if (data.index == 1) {
          table.reload('v2raylist')
        }
      });

      form.on('select(test_domain)', function (data) {
        // var value = data.value; // 获得被选中的值
        // var elem = data.elem; // 获得 select 原始 DOM 对象
        // var othis = data.othis; // 获得 select 元素被替换后的 jQuery 对象
        // layer.msg(this.innerHTML + ' 的 value: ' + value); // this 为当前选中 <option> 元素对象
        table.reloadData('nodeslist', { where: { domain: data.value } })
      });

      // 事件
      util.on('lay-on', {
        'routingrules': function () {
          layer.open({
            title: '<strong>路由分流规则</strong>(配置文件: default.env -> .env )',
            type: 1,
            area: ['80%', '80%'],
            content: $('#routingruleslayer'),
            success: (layero, index, that) => {
              form.render();
              form.on('submit(routingrules)', function (data) {
                submitbtn = document.getElementById("routingrulesbtn")
                var field = data.field;
                console.log(field.direct_ip_list)
                console.log(field)
                postjson("/api/v2ray/routing-rules/update", field, function (dt) {
                  layer.close(index)
                  layer.msg(dt.msg);
                  // table.reload('nodeslist')
                }, function (dt) {
                  console.log(field)
                  layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                }, submitbtn)
              })
            }
          })
        },
        // 'v2raylist': () => {
        //   layer.open({
        //     title: 'v2ray服务状态',
        //     type: 1,
        //     area: ['80%', '80%'],
        //     content: $('#v2raylistlayer'),
        //     success: (layero, index, that) => {
        //       table.reload('v2raylist')
        //     }
        //   })
        // },
        'subscribe': function () {
          layer.open({
            title: "更新订阅",
            type: 1,
            area: ['60%', '230px'],
            content: $('#subscribelayer'),
            success: (layero, index, that) => {
              form.render();
              form.on('submit(updatesubscribe)', function (data) {
                submitbtn = document.getElementById("updatesubscribe")
                var field = data.field;
                console.log(field)
                postjson("/api/nodes/subscribe", field, function (dt) {
                  layer.close(index)
                  layer.msg(dt.msg);
                  table.reload('nodeslist')
                }, function (dt) {
                  console.log(field)
                  layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                }, submitbtn)
              })
            }
          })
        }
      })

      // 创建渲染实例
      table.render({
        elem: '#nodeslist',
        url: '/api/nodes', // 此处为静态模拟数据，实际使用时需换成真实接口
        defaultToolbar: ['filter',
        {title: '基本设置', layEvent: 'settinglayer', icon: 'layui-icon-set'},
        {title: '清除缓存', layEvent:'clearlayer', icon:'layui-icon-delete'}
        ],
        escape: false,
        // height: 'full-120', // 移除高度限制，使用系统滚动条
        cellMinWidth: 80,
        skin: 'nob', // 无边框风格
        even: true, // 开启隔行背景
        cols: [[
          { type: "numbers", fixed: 'left', title: '#' },
          { field: 'index', width: 100, title: 'Index', sort: true, hide: true },
          { field: 'protocol', title: '协议', width: 80, templet: '<span class="px-2 py-1 bg-cyber-purple/20 text-cyber-purple rounded text-xs">{{d.protocol}}</span>' },
          { field: 'local_port', title: '本地端口', width: 110, sort: true, hide: true },
          { field: 'local_addr', title: '本机地址', width: 200, templet: '<span class="font-mono text-sm text-gray-300">{{d.local_addr}}</span>' },
          { field: 'speed', title: '速度/秒', templet: function(d) {
              let badgeClass = d.test_at != "0001-01-01 00:00" ? "bg-green-500" : "bg-gray-500";
              let speedText = d.speed >= 5 ? "100+" : d.speed;
              return `<span class="px-2 py-1 ${badgeClass} text-white rounded text-xs cursor-pointer" onclick="showTips('${d.test_url}', this)">${speedText}s</span>`;
            }, width: 100, sort: true },
          { field: 'title', title: '节点名称', width: 250, templet: '<span class="text-gray-200 truncate">{{d.title}}</span>' },
          { field: 'remote_addr', title: '节点地址', width: 200, templet: '<span class="font-mono text-sm text-gray-400">{{d.remote_addr}}</span>' },
          {
            field: 'is_running',
            title: '状态 <span id="status-sort-btn" class="cursor-pointer ml-2 text-cyber-purple hover:text-neon-purple transition-colors" onclick="toggleStatusSort()">⇅</span>',
            templet: function(d) {
              if (d.is_running) {
                return '<span class="status-running flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>运行中</span>';
              } else {
                return '<span class="status-stopped flex items-center"><span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>已停止</span>';
              }
            },
            width: 120
          },
          { field: 'test_at', title: '测速时间', width: 180, templet: '<span class="text-xs text-gray-400">{{d.test_at}}</span>' },
          { fixed: 'right', title: '操作', width: 180, minWidth: 180, toolbar: '#barDemo' }
        ]],
        done: function(res, curr, count) {
          // 保存原始数据用于排序
          if (!originalData) {
            originalData = JSON.parse(JSON.stringify(res.data));
          }
        },
        error: function (res, msg) {
          console.log(res, msg)
        }
      });

      // 直接绑定按钮事件
      $(document).ready(function() {
        // 测速按钮事件
        $('#testproxynodes').on('click', function() {
          layer.prompt({ title: '测速地址', value: '<{% .TestUrl %}>', placeholder: "请输入http/https开头的URL网址" }, function (value, index, elem) {
            if (value === '') return elem.focus();
            var btn = document.getElementById("testproxynodes")
            postjson("/api/nodes/test", { TestUrl: util.escape(value) }, function (dt) {
              layer.msg(dt.msg);
              var times = 4;
              interval = setInterval(function () {
                console.log("-----setInterval--times:", times)
                if (times > 0) {
                  table.reload('nodeslist')
                  btn.disabled = true;
                  btn.innerText = ((times < 10 ? "0" + times : times) + "s测速中");
                  times--;
                } else {
                  clearInterval(interval);
                  btn.disabled = false;
                  btn.innerText = "测速";
                  window.location.reload();
                }
              }, 2000);
            }, function (dt) {
              layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
            }, btn)
            layer.close(index);
          });
        });

        // 启动代理池按钮事件
        $('#startproxynodes').on('click', function() {
          var btn = document.getElementById("startproxynodes")
          console.log("启动代理池按钮被点击")
          postjson('/api/nodes/start', {}, function (dt) {
            layer.msg(dt.msg);
            var times = 1;
            interval = setInterval(function () {
              console.log("-----setInterval--times:", times)
              if (times > 0) {
                table.reloadData('nodeslist')
                btn.disabled = true;
                times--;
              } else {
                clearInterval(interval);
                btn.disabled = false;
              }
            }, 1500);
          }, function (dt) {
            layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
          }, btn)
        });

        // 停止代理池按钮事件
        $('#stopproxynodes').on('click', function() {
          var btn = document.getElementById("stopproxynodes")
          postjson('/api/nodes/stop', {}, function (dt) {
            layer.msg(dt.msg);
            table.reloadData('nodeslist')
          }, function (dt) {
            layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
          }, btn)
        });

        // 删除重复的系统代理按钮事件，激活节点时已自动设置系统代理
      });

      // 工具栏事件（保留用于其他功能）
      table.on('toolbar(nodeslist)', function (obj) {
        var id = obj.config.id;
        var checkStatus = table.checkStatus(id);
        var othis = lay(this);
        switch (obj.event) {
          case 'getCheckData':
            var data = checkStatus.data;
            layer.alert(layui.util.escape(JSON.stringify(data)));
            break;
          // case "refreshData": table.reload('nodeslist')
          //   break;
          case 'clearlayer':
            layer.confirm("删除runtime目录内所有文件：包括测速缓存等数据。",{icon:3, title:"确定清除应用缓存?"}, function(index){

              postjson("/api/setting/clearcache", {}, function (dt) {
                layer.close(index)
                layer.msg(dt.msg);
                window.setTimeout(function () {
                  window.location.reload();
                }, 1000)
              }, function (dt) {
                layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
              })

            })
            break;
          case 'settinglayer':
            layer.open({
              title: '系统设置(<{% .EnvFile %}>文件)',
              type: 1,
              area: ['50%', 'auto'],
              content: $('#settinglayer'),
              success: function (layero, index, that) {
                // 对弹层中的表单进行初始化渲染
                form.render();
                // 表单提交事件
                form.on('submit(setsubmit)', function (data) {
                  var submitbtn = document.getElementById("setupdatebtn")
                  // submitbtn.innerText = "提交中"
                  var field = data.field; // 获取表单字段值
                  console.log(field)
                  postjson("/api/setting/update", field, function (dt) {
                    layer.close(index)
                    layer.msg(dt.msg);
                    window.setTimeout(function () {
                      window.location.reload();
                    }, 3000)

                  }, function (dt) {
                    // submitbtn.innerText = "提交失败"
                    console.log(field)
                    layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                  }, submitbtn)
                  // layer.close(index); // 关闭弹层
                  return false; // 阻止默认 form 跳转

                });
              }
            });
            break;
        };
      });

      // 触发单元格工具事件
      table.on('tool(nodeslist)', function (obj) { // 双击 toolDouble
        var data = obj.data; // 获得当前行数据
        // console.log(obj)
        switch (obj.event) {
          // case 'edit':
          //   layer.open({
          //     title: '编辑 - id:' + data.id,
          //     type: 1,
          //     area: ['80%', '80%'],
          //     content: '<div style="padding: 16px;">自定义表单元素</div>'
          //   });
          //   break;
          case 'toggleRun':
            var posturl = data.is_running ? "/api/node/stop" : "/api/node/start"
            // var hintmsg = data.is_running ? '停止节点[' + data.title + ']吗？' : '启动节点[' + data.title + ']吗？'

            // 直接执行，不显示确认弹窗
            // layer.confirm(hintmsg, function (index) {
              postjson(posturl, { remote_addr: data.remote_addr }, function (dt) {
                layer.msg(dt.msg);
                table.reload('nodeslist');
              }, function (dt) {
                layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
              })
              // layer.close(index);
            // });
            break;
          case 'active':
            console.log(obj)
            var posturl = "/api/node/active"
            hintmsg = '激活[' + data.title + ']节点为系统代理吗？'
            if (data.is_active) {
              hintmsg = '取消[' + data.title + ']节点为系统代理吗？'
              posturl = "/api/node/unactive"
              layer.confirm(hintmsg, function (index) {
                postjson(posturl, { remote_addr: data.remote_addr }, function (dt) {
                  layer.msg(dt.msg);
                  table.reload('nodeslist');
                }, function (dt) {
                  layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                })
                console.log(data)
                layer.close(index);
              });

            } else {
              layer.open({
                title: hintmsg,
                type: 1,
                area: ['30%', 'auto'],
                content: $('#activenodelayer'),
                success: function (layero, index, that) {
                  // 对弹层中的表单进行初始化渲染
                  form.render();
                  // 表单提交事件
                  form.on('submit(activenode)', function (fdt) {
                    var submitbtn = document.getElementById("activenode")
                    // submitbtn.innerText = "提交中"
                    var field = fdt.field; // 获取表单字段
                    var postdata = {
                      remote_addr: data.remote_addr,
                      global_proxy: true
                    }
                    if (field.global_proxy == "0") {
                      postdata.global_proxy = false
                    }
                    console.log(field)
                    postjson(posturl, postdata, function (dt) {
                      layer.close(index)
                      layer.msg(dt.msg);
                      table.reload('nodeslist')

                    }, function (dt) {
                      // submitbtn.innerText = "提交失败"
                      console.log(field)
                      layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                    }, submitbtn)
                    // layer.close(index); // 关闭弹层
                    return false; // 阻止默认 form 跳转

                  });
                }
              });
            }

            break;
          case 'delete':
            var posturl = "/api/node/delete"

            layer.confirm("确定删除节点【" + data.title + "】？", function (index) {
              postjson(posturl, {index: data.index}, function (dt) {
                  layer.msg(dt.msg);
                }, function (dt) {
                  layer.alert(dt.msg, { icon: 2, title: dt.code + "错误" });
                })
                table.reload('nodeslist')
                console.log(data)
                layer.close(index);
              });
            break
        }
      });
    });

    // 状态排序功能
    function toggleStatusSort() {
      const table = layui.table;

      // 切换排序状态
      sortState = (sortState + 1) % 3;

      // 更新排序按钮显示
      const sortBtn = document.getElementById('status-sort-btn');
      switch(sortState) {
        case 0:
          sortBtn.innerHTML = '⇅';
          sortBtn.title = '点击按状态排序';
          break;
        case 1:
          sortBtn.innerHTML = '↑';
          sortBtn.title = '正序：运行中 → 已停止';
          break;
        case 2:
          sortBtn.innerHTML = '↓';
          sortBtn.title = '倒序：已停止 → 运行中';
          break;
      }

      // 获取当前表格数据
      let currentData;
      if (sortState === 0) {
        // 恢复默认排序
        currentData = JSON.parse(JSON.stringify(originalData));
      } else {
        // 获取当前数据并排序
        const tableData = table.cache.nodeslist || [];
        currentData = JSON.parse(JSON.stringify(tableData));

        currentData.sort((a, b) => {
          if (sortState === 1) {
            // 正序：运行中(true)在前，已停止(false)在后
            return b.is_running - a.is_running;
          } else {
            // 倒序：已停止(false)在前，运行中(true)在后
            return a.is_running - b.is_running;
          }
        });
      }

      // 重新加载表格数据
      table.reload('nodeslist', {
        data: currentData
      });
    }

  </script>

  <div id="settinglayer" style="display: none;">
    <{% tplinclude "setting_form.html" . | println %}>
  </div>

  <div id="addv2raylayer" style="display: none;">
    <{% tplinclude "add_v2ray_form.html" nil | println %}>
  </div>

  <div id="activenodelayer" style="display: none;">
    <{% tplinclude "active_node_form.html" nil | println %}>
  </div>

  <div id="copyrunlayer" style="display: none;">
    <{% tplinclude "copy_v2ray_form.html" . | println %}>
  </div>

  <div id="routingruleslayer" style="display: none;">
    <{% tplinclude "routing_rules_form.html" . | println %}>
  </div>

  <div id="subscribelayer" style="display: none;">
    <{% tplinclude "subscribe.html" . | println %}>
  </div>

</body>

</html>